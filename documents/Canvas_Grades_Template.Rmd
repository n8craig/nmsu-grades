---
title: "Canvas Grades"
output: html_notebook
---
This document contains sample code to connect to Canvas using the `rcanvas` package. This package provides a good method to retrieve a class list and grade books for individual classes.

# Load Libraries
```{r message=FALSE, warning=FALSE}
# Read canvas course information
library(rcanvas)

# Data wrangling
library(tidyverse)

# Plotting
library(ggplot2)
library(ggstatsplot)

# stats
library(rstatix)
library(easystats)
```


# Establish Connection to canvas
```{r}
# Enter token, set domain, and get class list
canvas_token <- rstudioapi::askForPassword("Canvas API Token")
set_canvas_token(token = canvas_token)
set_canvas_domain("https://nmsu.instructure.com")
get_course_list() %>% View()
```


# Select Class and Get Master Gradebook
```{r message=FALSE, warning=FALSE, include=FALSE}
# Loading the grade book is pretty slow.
# Assign grade book to a variable.
gb_all <- get_course_gradebook(1273540)
```
## Remove Unwanted Columns and Inspect Others

```{r}
# The raw gp contains many 'turnitin_data' cols,
# remove these to help see cols of interest.
gb <- gb_all %>% 
  select(-starts_with("turnitin_data"))

# Get list of col names
colnames(gb)
```

## Create Anon ID and Select Necessary Columns

```{r}
# Remove whitespace from assignment names
gb$assignment_name <- gsub('\\s+', '', gb$assignment_name)

# Create anonymous ID, select cols of interest, and
# drop na's associated with 'test student'
gb <- gb %>% 
  mutate(anon_id = str_c(
    str_sub(user.name, -3), str_sub(user_id, -3))
    ) %>% 
    select(anon_id,
           assignment_name, 
           score, 
           course_id) %>% 
  filter(anon_id != 0) %>% # Remove Test Student
  mutate_all(~replace(., is.na(.), 0)) %>% # Replace NA with 0
  mutate(assignment_name = as_factor(assignment_name))


```

## Filter Syntax for Assignments

```{r}
# Get Exams
gb %>% filter(str_detect(assignment_name, "^Exam"))

# Get quizzes
gb %>% filter(str_detect(assignment_name, "^Quiz"))

# Get films
gb %>% filter(str_detect(assignment_name, "^Film"))
```

## Get Assignment Counts
```{r}
gb %>% 
  filter(str_detect(assignment_name, "^Exam")) %>% 
  group_by(assignment_name) %>% 
  summarize(count=n())
```

# Graph Assignment Results


```{r}
#Exam 1
gb %>% 
  filter(., assignment_name == "Exam1") %>% 
  gghistostats(data = .,
             x = score,
             normal.curve = TRUE,
             normal.curve.args = list(color = "red", size = 1),
             ggtheme = ggthemes::theme_tufte(),
             title = "Exam 1 Scores"
             )

# Exam 2
gb %>% 
  filter(., assignment_name == "Exam2") %>% 
  gghistostats(data = .,
             x = score,
             normal.curve = TRUE,
             normal.curve.args = list(color = "red", size = 1),
             ggtheme = ggthemes::theme_tufte(),
             title = "Exam 2 Scores"
             )

# Exam 3
gb %>% 
  filter(., assignment_name == "Exam3") %>% 
  gghistostats(data = .,
             x = score,
             normal.curve = TRUE,
             normal.curve.args = list(color = "red", size = 1),
             ggtheme = ggthemes::theme_tufte(),
             title = "Exam 3 Scores"
             )
```


```{r}
gb %>% 
  filter(str_detect(assignment_name, "^Exam")) %>% 
  group_by(assignment_name) %>% 
  ggstatsplot::ggwithinstats(data = .,
               x = assignment_name,
               y = score
               )
```


## Plot Quiz Results
```{r}
gb %>% 
  filter(str_detect(assignment_name, "^Quiz")) %>% 
  ggbetweenstats(data = .,
               x = assignment_name,
               y = score,
               results.subtitle = FALSE,
               pairwise.comparisons = FALSE,
               )
```


# T-tests and Regression

## Create Attendance Score from Daily Attendance Quizzes
To sum attendance scores across multiple attendance quizzes, one approach involves pivoting from the native long format output by Canvas, where all assignments are in a single column, to a wide format where each assignment has its own column.
```{r}
gb_wide <- gb %>% 
  pivot_wider(names_from = assignment_name, values_from = score)
colnames(gb_wide)
```

Once pivoted wide, sum across all of the columns that are Attendance Quizzes and then drop the individual quizzes.
```{r}
gb_wide <-gb_wide %>% 
  mutate(attendance = select(.,7:34) %>% 
           rowSums(),
         .after = course_id) %>% 
  select(.,-(7:34))
```


```{r}
# gb_wide <- gb %>% 
#   filter(str_detect(assignment_name, "^Exam")) %>% 
#   pivot_wider(names_from = assignment_name, values_from = score)

```


## T-tests
One sample t-tests can be run to compare with a hypothetical mean.
```{r}
t_test(gb_wide, Exam1 ~ 1, mu=0)
t_test(gb_wide, Exam2 ~ 1, mu=0)
```

## Regression Analysis

```{r}
lm(Exam2~Exam1, data = gb_wide) %>% 
  report()
```


```{r}
gb_wide %>% 
  ggplot(., aes(Exam1, Exam2))+
  geom_point(aes(color = attendance))+
  geom_smooth(method = "lm")+
  scale_color_gradient(low="red", high="green")
```



```{r}
lm(Exam3~Exam2, data = gb_wide) %>% 
  report()
```


```{r}
gb_wide %>% 
  ggplot(., aes(Exam2, Exam3))+
  geom_point(aes(color = attendance))+
  geom_smooth(method = "lm")+
  scale_color_gradient(low="red", high="green")
```


```{r}
gb_wide %>% 
ggscatter(., x= "Exam2", y= "Exam3", color = "attendance")+
  geom_smooth(method = "lm")+
  stat_cor(label.x = 80, label.y = 50)+
  stat_regline_equation(label.x = 80, label.y = 40)+
  scale_color_gradient(low="red", high="green")
```


```{r}
lm(Exam3~Exam1+Exam2, data = gb_wide) %>% 
  report()
```

# Is Attendance a Predictor of Exam Performance?

Cumulative attendance explained a statistically not significant and weak proportion of the variance in Exam 1 ($R^2 = 1.05e-03, F(1, 41) = 0.04, p = 0.837, adj. R^2 = -0.02$). For Exam 1, attendance was not significant and positive ($b = 0.04, t(41) = 0.21, p = 0.837$).

```{r}
lm(Exam1~attendance, data = gb_wide) %>% 
  report()
```


```{r}
gb_wide %>% 
  ggplot(., aes(attendance, Exam1))+
  geom_point()+
  geom_smooth(method = "lm")
```
Cumulative Attendance explained a statistically not significant and weak proportion of the variance in Exam 2 ($R^2 = 0.08, F(1, 41) = 3.41, p = 0.072, adj. R^2 = 0.05$). The effect of Cumulative Attendance is statistically non-significant and positive ($b = 0.58, t(41) = 1.85, p = 0.072$).

```{r}
lm(Exam2~attendance, data = gb_wide) %>% 
  report()
```

```{r}
gb_wide %>% 
  ggplot(., aes(attendance, Exam2))+
  geom_point()+
  geom_smooth(method = "lm")
```

Cumulative Attendance explained a statistically significant and substantial proportion of the variance in Exam 3 ($R^2 = 0.36, F(1, 41) = 23.00, p < .001, adj. R^2 = 0.34$). The effect of Cumulative Attendance is statistically significant and positive ($b = 1.21, t(41) = 4.80, p < .001$).

```{r}
lm(Exam3~attendance, data = gb_wide) %>% 
  report()
```

```{r}
gb_wide %>% 
  ggplot(., aes(attendance, Exam3))+
  geom_point()+
  geom_smooth(method = "lm")
```

The effect of Cumulative Attendance increased with each exam and was significant on the final.